#% macro roll_button(name, title, dice, buttonLabel) %#
<button type='roll'
        name='roll_#$ name $#'
        value='&{template:adz} {{title=#$ title $#}} {{dice=[[#$ dice $#+0]]}} {{result=[[(#$ dice $#+0)d6>5cs>5cf<0 - @{penalty}]]}} {{penalty=@{penalty}}}'
        #%- if buttonLabel %#
        class="labelled">
    <label>#$ buttonLabel $#</label>
        #%- else -%#
        >
        #%- endif %#
</button>
#% endmacro %#

<div class="sheet-layout">

    <div class="sheet-basics">
        <label>Name</label>
        <input type="text" name="attr_character_name" />

        <label>Erfolgsabzug</label>
        <input type="number" step="1" name="attr_penalty" class="sheet-variable" value="0"/>

        <label>Benutzerdefinierte Probe</label>
        #$ roll_button('custom-roll', '?{Titel|Probe}', '?{Würfelanzahl|1}') $#
    </div>

    <div class="sheet-notes">
        <label>Notizen</label>
        <textarea name="attr_character_notes"></textarea>
    </div>

    <div class="sheet-attributes">
        <h2>Attribute</h2>

        <div class="sheet-attributes-list">
            #% for abbreviation, name in attributes %#
            #$ roll_button(abbreviation, name, '@{calc_total_' + abbreviation + '}', name) $#
            <div class="horizontal">
                <input type="number" step="1" name="attr_#$ abbreviation $#" max="10"/>
                <div class="stack clickable-total">
                    <input name="attr_calc_total_#$ abbreviation $#" class="number" readonly="true" />
                    #$ roll_button(abbreviation, name, '@{calc_total_' + abbreviation + '}') $#
                </div>
            </div>
            #% endfor %#
        </div>
    </div>

    <div class="sheet-skills">
        <h2>Fertigkeiten</h2>

        <div class="skill-list">
            <fieldset class="repeating_skills">
              <input type="text" name="attr_name" />
              <select name="attr_attribute">
                #% for abbreviation, name in attributes %#
                <option value="#$ abbreviation $#">#$ abbreviation $#</option>
                #% endfor %#
              </select>
              <input type="number" name="attr_value" />
              #! <button type='roll' name='roll_skill_@{name}' value='&{template:adz} {{name=@{name}}} {{erfolge=[[(@{value}+@{(@{repeating_skills_${x}_attribute})})d6>5 - @{abzug}]]}} {{abzug=@{abzug}}} {{wuerfel=99}}'></button> !#

                <div class="stack clickable-total">
                    <input name="attr_calc_total" class="number" readonly="true" />
                    #$ roll_button('@{name}', '@{name}', '@{calc_total}') $#
                </div>
            </fieldset>
        </div>
    </div>

    <div class="sheet-magic">
        <h2>Techniken & Magiebereiche</h2>

        <div class="sheet-magic-matrix">
            <div>#! label !#</div>
            <div>#! input !#</div>
            #% for technique in techniques %#
            <div class="vertical">
                <label>#$ technique $#</label>
                <input name="attr_#$ technique | lower $#" type="number" step="1" max="10"/>
            </div>
            #% endfor %#
            #% for domain in domains %#
            <label>#$ domain $#</label>
            <input type="number" step="1" name="attr_#$ domain | lower $#" max="10"/>
            #% for technique in techniques %#
            <div class="horizontal">
                <input name="attr_#$ domain | lower $#_#$ technique | lower $#" type="number" step="1" max="10" />
                <div class="stack clickable-total">
                    <input name="attr_calc_total_#$ domain | lower $#_#$ technique | lower $#" class="number" readonly="true" />
                    #$ roll_button(domain | lower + '_' + technique | lower, domain + ' ' + technique | lower, '@{calc_total_' + domain | lower + '_' + technique | lower + '}') $#
                </div>
            </div>
            #% endfor %#
            #% endfor %#
        </div>
    </div>

    <rolltemplate class="sheet-rolltemplate-adz">
        <h1>{{title}}</h1>
        <p>{{result}} Erfolge mit <span class="plain">{{dice}}</span> Würfeln</p>
        <p class="note">Erfolgsabzug von {{penalty}} berücksichtigt.</p>
    </rolltemplate>

</div>


<script type="text/worker">

function getIntegersFrom(values) {
    let result = {};
    for (const key of Object.keys(values)) {
        result[key] = parseInt(values[key]) || 0;
    }
    return result;
}

var attributes = [
    #% for abbreviation, name in attributes %#
        "#$ abbreviation | lower $#"
        #%- if not loop.last %#, #% endif -%#
    #%- endfor %#
];

for (const abbreviation of attributes) {
    addAttributeListener(abbreviation);
}

function addAttributeListener(abbreviation) {
    on("sheet:opened change:" + abbreviation, function() {
        console.log("attribute change:", abbreviation);
        getAttrs([abbreviation], function(values) {
            let integers = getIntegersFrom(values);

            var total = "";
            if (integers[abbreviation]) {
                total = integers[abbreviation] * 2;
            }

            let result = {};
            result["calc_total_" + abbreviation] = total;
            setAttrs(result);
        });
    });
}

on("sheet:opened", function() {
    getSectionIDs("repeating_skills", function(ids) {
        let valueIds = ids.map(id => "repeating_skills_" + id + "_value");
        let attributeIds = ids.map(id => "repeating_skills_" + id + "_attribute");
        var inputAttributes = valueIds.concat(attributeIds);
        bulkCalculateSkills(inputAttributes);
    });
});

on("change:repeating_skills", function(eventInfo) {
    console.log("change:", eventInfo.sourceAttribute);
    if (/_(value|attribute)$/.test(eventInfo.sourceAttribute)) {
        console.log("change", eventInfo);

        let inputAttributes = ["_value", "_attribute"].map(s => eventInfo.triggerName + s);
        console.log(inputAttributes);
        bulkCalculateSkills(inputAttributes);
    }
});

function bulkCalculateSkills(inputAttributes) {
    getAttrs(inputAttributes.concat(attributes), function(values) {
        let result = {};
        for (const key of Object.keys(values).filter(key => key.endsWith("_value"))) {
            let prefix = key.replaceAll("_value", "");
            calculateSkill(values, prefix, result);
        }
        console.log("bulk calculate result:", result);
        setAttrs(result);
    });
}

function calculateSkill(values, prefix, result) {
    let rawValue = values[prefix + "_value"];
    let value = parseInt(rawValue) || 0;

    let attributeAbbreviation = values[prefix + "_attribute"];
    let attributeRawValue = values[attributeAbbreviation];
    let attributeValue = parseInt(attributeRawValue) || 0;

    console.log("calculate " + prefix + " based on values: ", values);
    result[prefix + "_calc_total"] = attributeValue + value;
}


var techniques = [
    #% for technique in techniques -%#
        "#$ technique | lower $#"
        #%- if not loop.last %#, #% endif -%#
    #%- endfor %#
];

var domains = [
    #% for domain in domains -%#
        "#$ domain | lower $#"
        #%- if not loop.last %#, #% endif -%#
    #%- endfor %#
];

for (const domain of domains) {
    addRowListener(domain);
    for (const technique of techniques) {
        addCellListener(domain, technique);
    }
}

for (const technique of techniques) {
    addColumnListener(technique);
}

function addCellListener(domain, technique) {
    var combination = domain + "_" + technique;
    on("change:" + combination, function() {
        console.log("cell change", domain, technique);
        getAttrs([domain, technique, combination], function(values) {
            let result = {};
            calculateMagicCell(values, domain, technique, result);
            setAttrs(result);
       });
    });
}

function addRowListener(domain) {
    var inputAttributes = [domain].concat(techniques, techniques.map(technique => domain + "_" + technique));
    on("sheet:opened change:" + domain, function() {
        console.log("row change", domain);
        getAttrs(inputAttributes, function(values) {
            let result = {};
            for (const technique of techniques) {
                calculateMagicCell(values, domain, technique, result);
            }
            setAttrs(result);
        });
    });
}

function addColumnListener(technique) {
    var inputAttributes = [technique].concat(domains, domains.map(domain => domain + "_" + technique));
    on("change:" + technique, function() {
        console.log("column change", technique);
        getAttrs(inputAttributes, function(values) {
            let result = {};
            for (const domain of domains) {
                calculateMagicCell(values, domain, technique, result);
            }
            setAttrs(result);
        });
    });
}

function calculateMagicCell(values, domain, technique, result) {
    let integers = getIntegersFrom(values);
    var total = "";
    if (integers[domain] && integers[technique]) {
        total = integers[domain] + integers[technique] + integers[domain + "_" + technique];
    }
    result["calc_total_" + domain + "_" + technique] = total;
}
</script>
